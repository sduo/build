name: 'Tailscale DERP Server'
on:  
  # 手动触发
  workflow_dispatch:
jobs:
  Build:  
    strategy:
      matrix:
        env:
          - "GOARCH=arm64 GOOS=linux"
          - "GOARCH=amd64 GOOS=linux"
    runs-on: ubuntu-latest    
    env:
      GO-VERSION: '1.25.6'
    steps:      
      # https://github.com/actions/checkout
      - name: '检出 tailscale/tailscale 仓库'
        uses: actions/checkout@v6
        with:
          repository: tailscale/tailscale
          path: tailscale
          submodules: true
      # https://github.com/actions/setup-go
      - name: '初始化 Go 环境'
        uses: actions/setup-go@v6
        with:
          go-version: ${{env.GO-VERSION}}
      - name: '初始化编译环境'
        run: |
          export ${{ matrix.env }}
          mkdir --parents ${GITHUB_WORKSPACE}/artifacts/${GOOS}_${GOARCH}/derper
          cd ${GITHUB_WORKSPACE}/tailscale/cmd/derper
          go get .
        # https://github.com/tailscale/tailscale
      - name: '编译代码'
        run: |      
          export ${{ matrix.env }}
          cd ${GITHUB_WORKSPACE}/tailscale/cmd/derper
          go build -ldflags "-s -w" -v -o ${GITHUB_WORKSPACE}/artifacts/${GOOS}_${GOARCH}/derper/derper ./...          
      - name: '打包文件'
        run: |
          export ${{ matrix.env }}
          cd ${GITHUB_WORKSPACE}/artifacts/${GOOS}_${GOARCH}
          tar -czf derper_${GOOS}_${GOARCH}.tar.gz derper
      - name: '获取版本'
        id: 'version'
        run: |          
          export VERSION=$(cat '${GITHUB_WORKSPACE}/tailscale/VERSION.txt')
          echo ${VERSION}
        # https://github.com/actions/upload-artifact
      - name: '发布文件'
        uses: actions/upload-artifact@v4
        with:
          name: 'Tailscale DERP Server'
          path: ${{ github.workspace }}/artifacts/**/derper_*.tar.gz
          if-no-files-found: error
         


    
